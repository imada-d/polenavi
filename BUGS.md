# 未解決のバグリスト

最終更新: 2025-01-11

## 🔴 高優先度

### 1. ハッシュタグ保存機能でエラー発生
**症状:**
- ハッシュタグ・メモ保存機能を追加後、電柱登録時に500エラーが発生
- PC版、モバイル版両方で発生
- ハッシュタグがない場合でもエラーになる

**原因の可能性:**
- `data.hashtag` が `undefined` の場合の処理が不完全
- 型チェックが不十分（`Array.isArray` だけでは不十分？）
- フロントエンドから送信されるデータ形式の問題
  - PC版とモバイル版でハッシュタグの形式が異なる可能性
  - 空配列 `[]` ではなく `undefined` や `null` が送られている可能性

**関連コミット:**
- `712c8fb` - ハッシュタグ保存機能追加
- `82d1744` - null チェック追加（不十分）
- `7b530d0` - デバッグログ追加

**修正案:**
1. フロントエンドで送信前に必ず配列形式に正規化する
   ```typescript
   hashtag: hashtags && hashtags.length > 0 ? hashtags : undefined
   ```
2. バックエンドで完全な型ガード
   ```typescript
   const hashtags = Array.isArray(data.hashtag) ? data.hashtag : [];
   ```
3. メモ・ハッシュタグ保存を別トランザクションにする（オプション）

**テスト項目:**
- [ ] ハッシュタグなしで登録（PC版）
- [ ] ハッシュタグなしで登録（モバイル版）
- [ ] ハッシュタグありで登録（PC版）
- [ ] ハッシュタグありで登録（モバイル版）
- [ ] メモのみで登録
- [ ] メモ・ハッシュタグ両方で登録

---

### 2. 2枚番号入力時の登録エラー
**症状:**
- モバイル版で番号札2枚を入力すると登録できない
- 1枚だけなら登録できる
- 2番目を空欄にすると空文字列が送信される

**原因:**
- `numbers` 配列に空文字列 `''` が含まれる
- バックエンドのバリデーションで空文字列がエラーになる

**修正案:**
- フロントエンドで空文字列をフィルタ
  ```typescript
  const trimmedNumbers = numbers.map(n => n.trim()).filter(n => n !== '');
  ```

**関連コミット:**
- `0e6a3dc` - 空文字列フィルタ追加（後でリバート）

**状態:** 一時的に修正したがリバートした

---

## 🟡 中優先度

### 3. 次へボタンが底部ナビで隠れる
**症状:**
- 写真登録画面で「次へ」ボタンが底部ナビゲーションに隠れる
- たまに表示されないことがある

**修正状況:**
- `pb-20` → `pb-24` に変更済み（コミット `baadc84`, `0e6a3dc`）
- 確認画面は修正済み
- 他の画面でも同様の問題がある可能性

**TODO:**
- [ ] 全ての登録画面の `pb-` を確認
- [ ] 固定ボトムボタンのコンポーネント化を検討

---

### 4. ハッシュタグカウントが0になる（修正済み、テスト待ち）
**症状:**
- ハッシュタグを作成・添付しても、マイデータのハッシュタグカウントが0
- メモテーブルにハッシュタグが保存されていなかった

**原因:**
- 電柱登録時にメモレコードが作成されていなかった
- `getMyHashtags` API は `poleMemo` テーブルを参照

**修正状況:**
- ハッシュタグ・メモ保存機能を追加（コミット `712c8fb`）
- ただし、上記バグ#1により現在は動作しない

---

## 🟢 低優先度

### 5. 地図の広域表示
**症状:**
- 地図を都道府県レベルまで縮小すると電柱が消える

**修正状況:**
- 境界ボックス検索で修正済み（コミット `75b571e`, `61bcd66`）

---

## 📝 開発メモ

### デバッグ方法
1. サーバーログ確認コマンド
   ```bash
   ssh user@server "pm2 logs backend --lines 100"
   ```

2. 詳細ログ追加済み（コミット `7b530d0`）
   - 🔵 青マーク: 通常のデバッグログ
   - ✅ 緑マーク: 成功
   - ❌ 赤マーク: エラー

### 戻し方
現在のコミット: `205e62b` (写真登録が動いていた時点)

サーバーで更新:
```bash
cd ~/polenavi
git pull
npm run build --prefix backend
pm2 restart backend
```

---

## 次週の作業計画

1. **ハッシュタグ保存機能の修正**
   - フロントエンド・バックエンド両方でデータ形式を統一
   - より堅牢な型チェック
   - 段階的にテスト

2. **番号入力の修正**
   - 空文字列フィルタを再適用
   - バックエンドでも空文字列をスキップ

3. **統合テスト**
   - 全ての登録パターンをテスト
   - PC版・モバイル版両方
